name: "Deploy to STG/PRD"

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Áí∞Â¢É"
        required: true
        type: choice
        options:
          - "stg"
          - "prd"
      ref:
        description: "„Éá„Éó„É≠„Ç§ÂØæË±°„ÅÆ„Çø„Ç∞"
        required: true

permissions:
  contents: write

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  check-tag-exists:
    uses: ./.github/workflows/reusable-check-ref-exists.yaml
    with:
      ref: ${{ github.event.inputs.ref }}
      ref-type: tag

  check-prd-ref:
    needs: check-tag-exists
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
      - name: "Check PRD ref against STG ref"
        run: |
          if ! command -v yq &> /dev/null; then
            echo "Installing yq..."
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
          else
            echo "yq is already available: $(yq --version)"
          fi

          if [ "${{ github.event.inputs.env }}" != "prd" ]; then
            echo "üîÑ Not PRD environment, skipping ref check"
            exit 0
          fi

          INPUT_REF="${{ github.event.inputs.ref }}"
          STG_REF=$(yq '.stg.ref' .release.yaml)

          echo "Input ref: $INPUT_REF"
          echo "STG ref: $STG_REF"

          if [ "$INPUT_REF" != "$STG_REF" ]; then
            echo "‚ùå PRD ref does not match STG ref"
            exit 1
          else
            echo "‚úÖ PRD ref matches STG ref"
          fi

  notify-ref-mismatch:
    needs: check-prd-ref
    if: failure() && github.event.inputs.env == 'prd'
    uses: ./.github/workflows/reusable-slack-notify.yaml
    with:
      type: ref-mismatch
      environment: ${{ github.event.inputs.env }}
      branch: ${{ github.event.inputs.ref }}
      actor: ${{ github.actor }}
    secrets: inherit

  notify-deployment-start:
    needs: [check-tag-exists, check-prd-ref]
    uses: ./.github/workflows/reusable-slack-notify.yaml
    with:
      type: start
      environment: ${{ github.event.inputs.env }}
      branch: ${{ github.event.inputs.ref }}
      actor: ${{ github.actor }}
      workflow: ${{ github.workflow }}
    secrets: inherit

  deploy:
    needs: notify-deployment-start
    uses: ./.github/workflows/reusable-build-and-deploy.yaml
    with:
      node-version: '18'
      aws-region: ap-northeast-1
      s3-folder-name: "folder"
      build-output: "./dist/hoge.js" # TODO: „Åì„Åì„ÇíÂ§â„Åà„Çã
      environment: ${{ github.event.inputs.env }}
    secrets: inherit

  notify-deployment-failure:
    needs: deploy
    if: failure()
    uses: ./.github/workflows/reusable-slack-notify.yaml
    with:
      type: failure
      environment: ${{ github.event.inputs.env }}
      branch: ${{ github.event.inputs.ref }}
      actor: ${{ github.actor }}
      workflow-run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    secrets: inherit

  notify-deployment-success:
    needs: deploy
    if: success()
    uses: ./.github/workflows/reusable-slack-notify.yaml
    with:
      type: success
      environment: ${{ github.event.inputs.env }}
      branch: ${{ github.event.inputs.ref }}
      actor: ${{ github.actor }}
      workflow-run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    secrets: inherit

  update-release-file:
    needs: deploy
    if: success()
    uses: ./.github/workflows/reusable-update-release-file.yaml
    with:
      environment: ${{ github.event.inputs.env }}
      ref: ${{ github.event.inputs.ref }}
      actor: ${{ github.actor }}
    secrets: inherit
